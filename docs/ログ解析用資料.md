# ログ解析用資料

このドキュメントでは、ログに出力される内容について説明する


## タイミングログ（クライアント⇔LLM⇔クライアント）

「いつクライアントから要求が来たのか」「LLMにいつ送ったのか」「いつ返し始め、いつ終わったのか」が分かるように、時系列ログを出す。  
目的は**順番と時間差の把握**で、ペイロードは出さない方針です。

出力されるイベントは次の通り
- クライアント受信  
- クライアント不正リクエスト / クライアント要求エラー / クライアント応答エラー  
- LLM送信開始 / LLM送信完了 / LLM送信エラー  
- LLMストリーム終了 / LLMストリームエラー  
- クライアント送信開始 / クライアント送信終了

```
タイミング event=クライアント受信 request_id=... 経過ms=0
```

ストリームの場合は「送信開始」と「送信終了」が必ず分かるようにしているため、**配信の開始/終了タイミングが追える**状態になっている。


## 埋め込みログ（記憶検索用クエリ）

`＜＜ 記憶検索用クエリの埋め込み取得 ＞＞` 

「記憶検索のための2つの検索文（短文＋文脈付き）を埋め込みに送った」ことを示している

この埋め込みは記憶検索（Retriever）の検索キーを作るために行う
  - 2本のクエリ（短文＋文脈付き）のベクトルが得られる
    - 今の発話だけでは曖昧な場合でも、文脈込みで検索精度を上げるため2本の検索クエリ
  - それを使って 過去の会話（Episode）から関連度の高いものを検索できる
  - 取得した関連エピソードを **MemoryPack（内部コンテキスト）**に入れる
  -履歴は**直近3ターン（User/Partner合計6メッセージ）**
    - TODO: XX（定数名）で指定
    - 埋め込みAPIは **“テキスト→ベクトル”**が基本なので、会話の順序を保った1本のテキストのほうが**意味を保ちやすく、ノイズが少ない**

## エンティティ名抽出ログ（names only）

`＜＜ エンティティ（実体）名抽出 ＞＞`

  - MemoryPack 生成時に **常時使うLLM抽出（names only）**のログです。
  - 「わからないことは遠慮なく訊いてね。」のような文では、期待される返答は `{"names":[]}` です。  
  - 固有名が無ければ空配列になり、その後の MemoryPack には影響しない。


## 質問と回答（ログ解析の経緯・ドラフト）

### Q1. 「毎回システムプロンプトが変わるとキャッシュが効きにくい？」
A. その通り。暗黙キャッシュは先頭プレフィックス一致が前提なので、変動要素は後ろに寄せる方が有利。

### Q2. 「[system][past][emotion][new] の方がキャッシュ効く？」
A. 感情パラメーターが変動するなら後ろへ寄せる方が効きやすい。暗黙キャッシュ前提なら system を固定化するのが最も効果的。

### Q3. 「B（暗黙キャッシュ）前提でどうするのが良い？」
A. system を固定し、MemoryPack は内部コンテキストとして conversation 末尾に挿入する設計が最有力。

### Q4. 「[] 見出しは拾っちゃいそう。大丈夫？」
A. 衝突の可能性があるので、ユニークな見出しに変更するのが安全。`<<<COCORO_GHOST_SECTION:...>>>` に統一。

### Q5. 「internal_trailer と internal_trailer_parsed 両方いる？」
A. 解析が安定したので `internal_trailer_parsed` のログ出力は不要。削除済み。

### Q6. 「クライアント⇔LLM⇔クライアントのタイミングを知りたい」
A. タイミングログを追加し、受信/送信/ストリーム開始・終了が追えるようにした。

### Q7. 「日本語でログ出力して」
A. タイミングログの文言を日本語に統一。

### Q8. 「埋め込みログの名前は？」
A. `＜＜ 記憶検索用クエリの埋め込み取得 ＞＞` に変更。

### Q9. 「count は何？毎回2なら要らない？」
A. 入力本数だが常に2ではないので意味はある。ただし不要なら削除できるため削除。

### Q10. 「approx_chars 表記を変更して」
A. `文字数=` に変更し、埋め込み以外のログも統一。

### Q11. 「埋め込みログの input キーをなくしたい」
A. `input` を削除し、配列のみをログに出す形式へ変更。

### Q12. 「PERSONA_ANCHOR と出力フォーマットが混ざって見える」
A. system prompt 内で `<<<COCORO_GHOST_SECTION:OUTPUT_FORMAT>>>` を追加し、人格設定（PERSONA_ANCHOR）と出力フォーマット指示を明確に分離した。

### Q13. 「LLM request ログの model は不要」
A. LLM の送信/失敗/受信ログから `model=` を削除した。

### Q14. 「前処理の並列化はどこ？」
A. `/api/chat` などの前処理で、Retriever検索と entity名抽出（names only）を並列に実行する。entity名抽出は前処理側（`memory.py`）で行い、`build_memory_pack()` には解決済みの `matched_entity_ids` を渡す。

