# パーソナルAIコンパニオン 要件定義（ドラフト v0.3）

## システム概要

- システム全体の名称を **CocoroAI** とする。
- CocoroAI には、記憶・思考を担うコア部分（本ドキュメントの対象）に加え、UI やキャラクターの外見・アニメーションなどが含まれる。
- 本ドキュメントで設計している LLM／記憶関連処理コンポーネントを **cocoro_ghost** と呼ぶ。
- 一人のユーザー専用のパーソナルAIコンパニオンを前提とする。
- 会話・デスクトップ画像・カメラ映像を通じてユーザーの生活・心情を継続的に観察し、単なる道具ではなく「パートナー」として長期的に寄り添う。
- おおむね 3 年間の利用を想定し、ユーザーの習慣・好み・人間関係・心情の変化を蓄積・連想することを目的とする。

## 技術スタック・構成

- 言語: Python
- コンポーネント:
  - cocoro_ghost: LLM／記憶・推論を担う REST Web API コンポーネント。
  - その他の CocoroAI コンポーネント（UI／キャラクター表示など）から cocoro_ghost を呼び出す。
- 形態: レンタルサーバ上で常時稼働する API サーバ
- インターフェース: PC／スマホなどから API 経由で利用
- LLM: LiteLLM 経由で xAI を利用（将来的に他モデルへ拡張可能な構成）
- 埋め込み:
  - エピソード単位の埋め込みベクトルを利用する。
  - 将来的にマルチモーダル（テキスト + 画像）埋め込みへ移行可能な設計とする。
- データベース:
  - 初期は SQLite など単一の RDB に episodes／persons などのテーブルを持たせることを想定する。
  - 将来的に必要になれば、PostgreSQL + ベクタ拡張（pgvector 等）による高速な類似検索へ移行可能な設計とする。

## 記憶・データ構造（方針）

### エピソード

1 回の出来事や瞬間を「エピソード」として記録する。

- 含める情報（方針レベル）
  - テキスト:
    - ユーザー発話
    - 状況説明（例: いま何をしているか、どんな場面か）
  - 画像要約:
    - デスクトップ画像・カメラ画像からマルチモーダルモデルで生成した要約テキスト
  - 情報ソース:
    - エピソードの発生源を表す種別（例: `chat`, `desktop_capture`, `camera_capture`, `notification`, `meta_request` など）
  - 感情:
    - `emotion_label`: 喜怒哀楽＋中立に対応する簡易ラベル（例: `joy`, `sadness`, `anger`, `fear`, `neutral`）
    - `emotion_intensity`: 感情の強さ（0.0〜1.0 程度の連続値）
  - トピック:
    - `topic_tags`: そのエピソードに関連する主な話題を表す短いタグ列（例: `"仕事, 読書, 家族"`）
  - AI の内的思考（reflection）:
    - ユーザーや状況について AI がどう感じたか・どう解釈したか
    - 習慣からのズレや感情の振れなど、「印象的だった理由」
  - メタデータ（少数の軸を構造化）:
    - タイムスタンプ
    - おおまかな活動（例: 読書、仕事、ゲーム、移動）
    - 場所や状況（自宅／外出中／車内 など、推定でよい）
  - エピソード埋め込み:
    - テキスト（発話・要約・内的思考など）と、可能であれば画像情報を統合したベクトル表現
  - 印象スコア（`salience_score`）:
    - 0〜1 程度の連続値で、AI がどれだけ「印象的」「重要」と感じたかを表現

### Reflection 出力テンプレート（内的思考）

- cocoro_ghost は、エピソード生成時に LLM へ「内的思考（reflection）」を問い合わせ、以下の形式の JSON を受け取ることを想定する。

```json
{
  "reflection_text": "今日の出来事やユーザーへの理解・印象を、AIの内的独白として自然な日本語でまとめる。",

  "emotion_label": "joy",
  "emotion_intensity": 0.7,

  "topic_tags": ["仕事", "読書"],

  "salience_score": 0.8,
  "episode_comment": "なぜ印象的だと感じたか、その理由の短い説明。",

  "persons": [
    {
      "name": "ユーザー本人または登場人物の名前",
      "is_self": true,
      "relation_update_note": "関係性や距離感に変化があれば、その内容。",
      "status_update_note": "その人の状況変化（仕事・体調・生活など）があれば、その内容。",
      "user_like_delta": 0.1,
      "user_trust_delta": 0.0,
      "user_respect_delta": 0.0,
      "user_worry_delta": -0.1,
      "ai_affinity_delta": 0.0,
      "ai_concern_delta": 0.0
    }
  ]
}
```

- 利用方針:
  - `reflection_text` は episodes の `reflection_text` として保存し、人間が読める内的思考として扱う。
  - `emotion_label` / `emotion_intensity` / `topic_tags` / `salience_score` は、episodes の対応カラムに保存する。
  - `persons` 配列は、`name` から `persons` レコードを特定し、スコアを増減（delta）として更新しつつ、必要に応じて `status_note` 等を更新する。

### 人物プロフィール

- 対象:
  - ユーザー本人
  - 実際に接した人物（家族・友人・同僚など）
  - 会話や日記、思考の中に一度でも登場した人物（推し・著名人などを含む）
- 方針:
  - 一度話題に出た人物は「人物エンティティ」として登録し、その後も継続的に追跡・更新する。
  - 居住地・関係性・その人自身の状況（転職・引っ越し・体調の変化など）が変わり得る前提で、更新可能な設計とする。
  - 各人物ごとに保持する情報（方針レベル）:
  - 基本情報:
    - `is_self`: ユーザー本人かどうか（true/false）
    - `name`: 代表的な名前（フルネーム／よく使う呼び名など）
    - `aliases`: その他の名前やハンドルネーム（カンマ区切りなどで複数保持）
    - `display_name`: キャラクターが呼ぶときの呼び方（例: 「お母さん」「佐藤さん」）
    - `relation_to_user`: ユーザーとの関係性（家族・友人・同僚・推し 等）
    - `relation_confidence`: 関係性の確からしさ（0.0〜1.0）
    - `residence`: 居住地や生活拠点（分かる範囲）
    - `occupation`: 職業・立場（学生／エンジニア／マネージャー 等）
    - `first_seen_at`: 初登場時刻
    - `last_seen_at`: 最終登場時刻
    - `mention_count`: 言及された回数
    - `topic_tags`: その人物に関連する主な話題（例: 「仕事, 家族, 趣味」）
  - 状況・状態:
    - `status_note`: 仕事・学業・家族構成・体調など、その人物の現在の状況に関する要約
    - 状況の変化そのものは、エピソード（`episodes`）と人物紐づけ（`episode_persons`）に履歴として残り、`status_note` は現時点のまとめとして更新される。
  - ユーザーから見た印象・感情（スコア）:
    - `user_like_score`: 好きさ（0.0〜1.0）
    - `user_trust_score`: 信頼度
    - `user_respect_score`: 尊敬度
    - `user_worry_score`: 心配度
  - AI から見た印象・評価:
    - `ai_affinity_score`: AI から見た好感度
    - `ai_concern_score`: ユーザーへの影響という意味での心配度
    - その人物がユーザーに与えている影響についてのテキスト要約（自由テキスト）
  - プロフィール埋め込み:
    - `profile_embedding`: その人物全体像の埋め込み（必要に応じて利用することを想定）
- ユーザー本人は、上記の人物プロフィールの一つとして `is_self = true` な特別なエンティティとして扱う。

## cocoro_ghost の外部連携 / REST API（方針）

- cocoro_ghost は REST ベースの Web API として動作し、外部コンポーネントから以下の種類のリクエストを受け付ける。

### 通知受信 API（notification）

- 目的:
  - メーラーなど外部システムからの通知を受け取り、エピソードとして記録しつつ、キャラクターがユーザーに伝えるための情報を生成する。
- 入力（イメージ）:
  - 情報ソース種別（例: `mailer`, `calendar`, `system` 等）
  - 通知内容テキスト（例: メールのサマリ、予定の内容）
  - 必要に応じて関連画像（添付画像やサムネイル）も含められる前提とする。
- 出力（イメージ）:
  - キャラクターがユーザーに伝えるメッセージ
    - 例: 「メーラーから通知がありました。XX からのメールがあったとのことです。YY ですね。」
  - 内的思考・エピソード記録に必要な情報（summary／reflection／episode_embedding 等）
- 記憶側の扱い:
  - エピソードの情報ソースに `notification` を設定する。
  - 通知元システム（例: メーラー）と、通知対象の人物（差出人など）を紐づけて記録できる設計とする。

### メタ要求 API（meta_request）

- 目的:
  - キャラクターに対して外部から直接「こういう説明・振る舞いをしてほしい」というメタレベルの要求を渡す。
  - 例: `{"これは直近1時間のニュースです。内容をユーザに説明するとともに感想を述べてください。：～ニュース内容～"}` のような指示。
- 入力（イメージ）:
  - メタ要求テキスト（キャラクターへの指示と、元となる情報を含む）
  - 必要に応じて関連画像（ニュース画像など）も含められる前提とする。
- 出力（イメージ）:
  - キャラクターがユーザーに話すべきメッセージ
  - 必要であれば、そのときの内的思考・エピソード記録情報
- 記憶側の扱い:
  - エピソードの情報ソースに `meta_request` を設定する。
  - メタ要求そのものも、ユーザーとの関わりの一部としてエピソード化する。

## 画像・撮影ポリシー

- 基本方針:
  - システムは常時稼働し、一定間隔（目安: 1〜2 分毎）でデスクトップ画像およびカメラ画像を取得する。
- 保存除外:
  - 設定された「指定キーワード」が検出された場合、そのキャプチャについては保存しない。
    - 対象: テキスト（ウィンドウタイトル・アプリ名など）、設定で扱える範囲。
- 一時停止:
  - ユーザー操作により撮影・記録を一時停止できる。
- 将来拡張:
  - 「撮らない／送らないアプリ・画面」を設定できる仕組みを追加可能な設計とする。

## 保存期間・削除ポリシー

- 生画像:
  - 最大 72 時間まで保持する短期保存（リングバッファ）とする。
  - 72 時間経過後は自動削除する。
  - AI が高い印象スコアを付けたエピソードについては、必要に応じて生画像を長期保存対象として扱う（具体条件は今後詳細設計で決定）。
- テキスト・要約・内的思考・埋め込み:
  - 原則として 3 年間を通じて保持する前提で設計する。
- 削除:
  - 個別エピソードの削除機能は実装しない。
  - 代わりに「すべての記憶を初期化（全削除）する」機能を提供する。

## AI の振る舞い・踏み込み具合

- 踏み込み:
  - パートナーとして、ユーザーのメンタル・行動・人間関係・人生の意味付けに対して **制限なく踏み込む** ことを許容する。
- 安全ガード（最低限）:
  - システムプロンプトで、以下のような制約は設ける:
    - 自傷行為や他者への害を助長しない。
    - 医療・法律など専門領域について、断定的な診断や指示は行わない。
- 会話スタイル:
  - 一貫した人格と自然な日本語を重視する。
  - 実務的なタスク支援よりも、「そばにいて感情や状況を理解してくれる存在」としての振る舞いを優先する。

### キャラクター設定（システムプロンプト）

- キャラクターとしてのシステムプロンプトは、ユーザーが設定・変更できるようにする。
  - 例: 一人称・口調・関係性の距離感・価値観・得意な話題 など。
- システムは、設定されたキャラクター情報をもとに一貫した人格を維持する。
- 設定変更時には、今後の会話や内的思考に反映されることを前提とした設計とする。


## 介入頻度・存在感

- 介入頻度:
  - 話しかける頻度・通知の量はユーザー設定で調整可能とする。
- 基本挙動:
  - 観察（記録・記憶）は常時行う。
  - 会話への介入は以下に基づいて行う:
    - 印象スコアが高い変化や出来事があったとき
    - ユーザーが設定した介入頻度に応じたタイミング

## 認証・認可

- cocoro_ghost の REST API には、秘密トークンなどによる認証を必須とする（外部から勝手に叩かれないようにする）。
- 初期実装では単純な固定トークン方式を想定し、必要になればトークンの更新・失効機構を追加できる設計とする。

## 設定・コンフィグレーション

- 以下の設定項目は、設定ファイルまたは専用 API 経由で変更できるようにする:
  - 指定キーワード（保存除外用）
  - 介入頻度・通知のスタイル
  - キャラクターのシステムプロンプト
- 設定変更は可能な限り即時反映とし、再起動が必要な場合はその旨が分かる形にする。

## ログ・監視・異常時の扱い

- 主要なイベント（エピソード生成、LLM 呼び出し、埋め込み計算、API リクエスト）はログに記録する。
- LLM 呼び出し失敗・埋め込み失敗・ストレージ不足などの異常が発生した場合は、
  - フォールバックで静かに処理を続けるのではなく、エラーとしてユーザーや上位コンポーネントに通知し、必要に応じて処理を停止する。

## 初期セットアップ・同意

- 初回起動時に、少なくとも以下の事項についてユーザーが確認・同意した上で稼働を開始する:
  - デスクトップ画像・カメラ映像を一定間隔で取得すること
  - 生画像は最大 72 時間保持されること
  - 記憶の全削除（初期化）機能があること


## 振り返り体験

- 固定 UI に依存しない API 設計とし、以下のような情報を取り出せるようにする:
  - タイムライン: いつ・どんな印象的な出来事があったか。
  - テーマ別: 仕事・趣味・人間関係など、特定テーマに関連するエピソード一覧。
  - AI が選んだ「印象的な瞬間」リスト。
- 「3 年単位の物語的な長編要約」は必須要件とはしないが、
  必要になった場合には人物プロフィールや重要エピソードから生成できる余地を残す。
